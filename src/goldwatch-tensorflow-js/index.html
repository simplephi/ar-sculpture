<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tfjs</title>
</head>
<body>
    <video id="main-stream-video" width="100%" height="100%"></video>
    <script src="https://unpkg.com/@tensorflow/tfjs"></script>
    <script src="https://unpkg.com/@tensorflow/tfjs-automl"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        model = null;

        function preprocessImage(image){
            let tensor = tf.browser.fromPixels(image);
            return tensor;
        }

        function captureWebcam() {
            var canvas    = document.createElement("canvas");
            var context   = canvas.getContext('2d');
            canvas.width  = video.width;
            canvas.height = video.height;

            context.drawImage(video, 0, 0, video.width, video.height);
            tensor_image = preprocessImage(canvas);

            return tensor_image;
        }

        var children = [];
        const liveView = document.getElementById('main-stream-video');

        async function predict() {
            let tensor = captureWebcam();

            // const options = {score: 0.5, iou: 0.5, topk: 20};
            const predictions = await model.detect(tensor);
            // Remove any highlighting we did previous frame.
            for (let i = 0; i < children.length; i++) {
              liveView.removeChild(children[i]);
            }
            children.splice(0);

            for (let prediction of predictions) {

                // console.log(prediction.score);
                // if (prediction.score > 0.70) {
                //     console.log(prediction.box);
                //
                // }

                console.log(prediction);

                if (prediction.score > 0.70) {
                  const p = document.createElement('p');
                  p.innerText = prediction.label  + ' - with '
                      + Math.round(parseFloat(prediction.score) * 100)
                      + '% confidence.';
                  p.style = 'margin-left: ' + prediction.box[0] + 'px; margin-top: '
                      + (prediction.box[2] - 10) + 'px; width: '
                      + (prediction.box[3] - 10) + 'px; top: 0; left: 0;';

                  const highlighter = document.createElement('div');
                  highlighter.setAttribute('class', 'highlighter');
                  highlighter.style = 'left: ' + prediction.box[0] + 'px; top: '
                      + prediction.box[2] + 'px; width: '
                      + prediction.box[3] + 'px; height: '
                      + prediction.box[1] + 'px;';

                  liveView.appendChild(highlighter);
                  liveView.appendChild(p);
                  children.push(highlighter);
                  children.push(p);

                }
            }
            // Show the resulting object on the page.
            // const pre = document.createElement('pre');
            // pre.textContent = JSON.stringify(predictions, null, 2);
            // document.body.append(pre);
        }

        tf.automl.loadObjectDetection('https://raw.githubusercontent.com/simplephi/ar-sculpture/main/src/goldwatch-tensorflow-js/model.json').then(function (loadedModel) {
            model = loadedModel;

            video = $('#main-stream-video').get(0);
            vendorUrl = window.URL || window.webkitURL;

            return navigator.mediaDevices.getUserMedia({
                // video: true,
                video: {
                  facingMode: {
                    exact: 'environment'
                  }
                },
                audio: false
            }).then(function(stream) {
                localStream = stream;
                video.srcObject = stream;
                video.play();
                setInterval(predict, 1000/10);
            }).catch(function(error) {
                alert("Something wrong with webcam!");
            });
        });
    </script>
</body>
</html>
